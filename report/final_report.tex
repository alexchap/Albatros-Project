
\documentclass[a4paper,english]{IEEEtran}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{graphicx}

\usepackage[unicode=true, pdfusetitle,
 bookmarks=true,bookmarksnumbered=false,bookmarksopen=false,
 breaklinks=false,pdfborder={0 0 1},backref=false,colorlinks=false]{hyperref}

\makeatother

\usepackage{babel}

\begin{document}

\date{December 2011}

\author{Alexandre Chappuis, Bastian Marquis and David Klopfenstein @ EPFL.ch}

\title{Implementation of a BGP Route Flap Damping Algorithm for the Bird
Routing Project}

\maketitle

\begin{abstract}
Today's Internet stability strongly relies on the good behaviour of
dynamic routing protocols such as BGP (Border Gateway Protocol), which
enables routing between Autonomous Systems. Route flapping is a well-known
and undesirable phenomenon occuring in both commercial and private
networks. In this report, we explain our implementation of the RFC
2439, BGP Route Flap Damping, for one famous Open Source routing software
suite, the Bird Routing Project.

We also present results of an experiment where we compared the number
of BGP updates sent with and without route damping enabled, in a simplified setup
where only one of the bgp router was receiving advertisments for flapping
routes.
\end{abstract}

\section{Introduction}

The inter-domain routing protocol BGP is still surviving to the gigantic
growth of the Internet that started during the last decade. However,
some widely used applications, such as Skype, still suffer from weaknesses
in that protocol. The main problems are twofolds: firstly, BGP has
a slow convergence rate, meaning that a change at one location can take
long before it is propagated to the other ends of the network.
Secondly, if a node becomes unstable, for example if its connectivity
constantly comes up and down, it will have bad consequences on the
network, both in terms of useless processing at BGP routers and unnecessary
routing traffic. Routes advertised and withdrawn at regular interval
of time are said to be \textit{flapping}.

Many approaches to counter route flapping have been developped in
the late 90's. RFC 2439\cite{rfc2439} standardized one such approach
: it basically blocks updates from flapping routes, and does so until
the routes are deemed stable again. This RFC has been used extensively
for many years, in both commercial and open source routers.

Although this standard is not recommended anymore\cite{ripe recommendations}
in today's routers, we wanted to implement it for the Bird Routing
Project\cite{bird}, hoping that it will serve as a good basis for
future possible improvements and extensions to this RFC. There exist
many variants of the Route Flap Damping alorithm and the community
has not lost its interest in finding robust mechanisms that could
allow BGP to be more resilient.


\section{Overview}

RFC 2349 seeks to limit the impact of route flapping by ``damping''
(\textit{i.e.} ignoring packets of) missbehaving routes. The solution
must be able to distinguish flapping routes from good routes and consume
few resources, both in terms of memory usage and process time. The
RFC solves these problems by assigning each route a penalty term.
Whenever this penalty term for a given route reaches a certain threshold,
further advertisements for that route are ignored. This penalty term
varies over time : it is increased when the route becomes unreachable
and decays as long as the route stays stable. As soon as the figure
of merit goes below a \textit{reuse threshold}, the route can be used
again.

The figure of merits decays exponentially over time. Exponential decay
has several advantages : it can be implemented very efficiently using
precomputed \textit{decay arrays}. Also, with exponential decay, the
figure of merit keeps trace of previous instabilities for a fairly
long time : old instabilities become less and less important over
time, while newer ones have more weight.

Network administrators have lots of freedom in choosing the behavior
of the penalty term : they can control the half-life of the penalty
term, its maximum value (thus controlling the maximum time a route
can be suppressed) and both the reuse and cut thresholds.

Here is an example showing how the figure of merit evolves over time
(the illustration comes from \cite{damping-pic}). The route flaps
three times, exceeding the cut threshold only after the third flap.
The route is reused as soon as its penalty term goes below the reuse
limit.

\begin{center}
\includegraphics[scale=0.5]{route_damping} 
\par\end{center}

Penalty terms are re-computed at regular time intervals using timers.
Also, every time an update for a route is received, the penalty term
for that route is re-computed.

The RFC proposes several optimizations to decrease processing time,
at the cost of a slightly bigger memory footprint. \textit{E.g. reuse
lists} are used to not have to recompute the figure of merit of all
routes : damped routes with similar penalty terms are grouped together
in a same reuse list. Penalty terms of the routes in a given reuse
list are then re-computed only when necessary.


\section{Implementation}

Our implementation contains most of the data structure definitions
and functions needed for the route damping algorithm (RFC 2439).
As the RFC leaves little freedom regarding the implementation and the 
design of the data structures, our implementation closely matches the RFC.
The code, along with the list of commits, is publicly available on
{\tt\small https://github.com/alexchap/Albatros-Project}.

Several parts of BIRD had to be modified for the implementation of route damping.
The configuration file parser had to be modified in order to correctly handle the parameters
required by the RFC.
Also, we had to make similar modifications to the command line parser so that suppressed routes
could be listed using the \texttt{\small show dampened paths} command.
The \texttt{\small show protocols all} was also extended with a ``damped'' field, indicating whether a route is damped or not.
Last but not least, we had to add hooks to BIRD's BGP implementation : whenever a route is added or withdrawn, our code is executed.
Route damping is enabled at configure time by adding the {\tt\small -{}-enable-route-damping}
switch.

\subsection{Data structures}

The data structures used by the implementation are very close to those described 
in the RFC (\S4.4, \textit{Run Time Data Structures}).
The most important of which are certainly {\tt\small damping\_config} and
{\tt\small damping\_info}.
Their definitions can be found in {\sl damping.h}.

{\tt\small damping\_config} groups all configurations parameters for a BGP peer.
This allows network administrators to have different sets of parameters for
differents routes. {\it I.e} \texttt{\small damping\_config}s have a one-to-one relation
to BIRD's \texttt{\small bgp\_proto}.
This structure contains all the parameters controlling the behaviour of the damping algorithm :
\texttt{\small reuse\_threshold}, \texttt{\small cut\_threshold}, 
\texttt{\small ceiling}, \texttt{\small tmax\_hold} and \texttt{\small half\_time}.
Additionally, it contains some informations used to speedup the algorithm (at the cost of a more
important memory consumption) : both the decay arrays and the reuse lists are contained here.
The former speeds up the computation of new figure of merits by pre-computing a predefined set
of (costy) exponentials and using them when figures of merit needs to be updated.
The latter limitates the time of computation at every timer tick by grouping damped routes
according to their penalty term.
Instead of being updated at every tick, a group of routes is updated once every $n$ ticks, 
where $n$ is the number of reuse lists.
Reuse lists are implemented using \texttt{\small slist}s, a doubly linked list implementation provided by BIRD.

BIRD's timer are used to regularly update the penalty terms of routes : every \texttt{\small bgp\_proto} structure
contains a \texttt{\small reuse\_list\_timer}.
These timers are set up to call \texttt{\small damping\_reuse\_timer\_handler} at every tick.
This function is responsible for updating the penalty terms of damped routes and re-inserting damped routes
into the routing table if their penalty term is low enough.

The core of the damping algorithm lies with the \texttt{\small damping\_info} structure.
The penalty term is stored in that structure, along with a timestamp indicating when the last
update of the penalty term was.
Other informations, such as the IP prefix of the route, reuse list pointers and route attributes (BIRD specific) are also included
in \texttt{\small damping\_info}.
One such structure is allocated once a route starts to flap, and is de-allocated whenever the penalty term becomes ``small enough''.
There is a one-to-one mapping between routes (\texttt{\small rte} in BIRD) and \texttt{\small damping\_info}.
This mapping was made possible by FIBs, an hash table implementation provided by BIRD's API.
FIBs basically map IP prefixes to any other data structure, {\tt\small damping\_info}s in our case.

Last but not least, the fact that BIRD uses only one thread made our job much simpler as we didn't have to worry about concurrency.

\subsection{Configuration parameters}

Our extended version of BIRD gives network administrators a set of four parameters to control the behaviour of route damping.
In particular, {\tt\small cut\_threshold}, {\tt\small reuse\_threshold}, {\tt\small tmax\_hold} and {\tt\small half\_time} are all modifiable
from the configuration file.
Both {\tt\small tmax\_hold} (the maximum time a route can be kept damped, it defines the ceiling value)  and {\tt\small half\_time} (the time taken by a penalty term to diminish by half its value) are expressed in seconds.
Here is an example of configuration :

\begin{verbatim}
protocol bgp bgp_config {
  descriptionl "BGP daemon";
  debug all;

  # Specific config for BGP
  local as 65011;
  source address 10.10.10.11;
  multihop;
  next hop self;
  path metric 1;
 
  # Route damping configuration
  route damping;
  cut_threshold 2500;
  reuse_threshold 1000;
  tmax_hold 3000;
  half_time 900;
}
\end{verbatim}

The default parameters (hard coded in \textsl{damping.h}) are :

\begin{center}
\begin{tabular}{|l|c|}
\hline
\texttt{\small cut\_threshold} & 1500 \\
\hline
\texttt{\small cut\_threshold} & 750 \\
\hline
\texttt{\small half\_time} & 900 \\
\hline
\texttt{\small tmax\_hold} & 3000 \\
\hline
\end{tabular}
\end{center}

The {\tt\small route damping} parameters can be used to enable/disable route damping for a particular neighbour.
All the other parameters used by the RFC (\textit{e.g.} decay arrays, scaling factor, ...) are derived from
those four values.

BIRD uses Bison to parse the configuration files and we had to extend it to support the new set of keywords.
Those parameters are passed to the {\tt\small damping\_config\_new} function, which allocates and initializes a new {\tt\small damping\_config} and computes the 
other parameters.
Finally, checks are made to ensure that the parameters are consistent with each other.
\textit{E.g.} the \texttt{\small cut\_threshold} must be bigger than \texttt{\small reuse\_threshold}, and damping should be enabled only for E-BGP.

\subsection{Detecting BGP Flapping}

Our implementation sticks to the RFC regarding route flapping detection.
Hooks were added in the BGP module of BIRD for that purpose.
Those hooks ensure that the {\tt\small damping\_add\_route} or {\tt\small damping\_remove\_route} functions are 
called when routes are advertised or withdrawn, respectively.

As those functions are similar to their equivalent in the RFC, only the relevant implementation details are covered here.
Please refer to the RFC for additional details.

When a route is removed for the first time, a new {\tt\small damping\_info} is allocated in a {\tt\small damping\_info\_fib}, and its penalty term is set to a default value.
The penalty term of this route is updated as the route is re-advertised and removed again.
In particular, when the route is removed, its penalty term is updated and then incremented by a default value : 1000, whereas when it is added, its penalty term is just updated.
The penalty term is represented by a scaled integer, so that only the right level of precision is kept during execution.
The main idea is that floating point operations are used when the figure of merit needs to be updated, but the result is stored as an integer (thus saving memory space).
This usually results in an accidental loss of precision, except that in our case, the decrease in precision is controlled so as not to crash the application.
Penalty terms are all implicitely multiplied by 1000, implying that only three digits after the dot are kept.

{\tt\small damping\_info} are de-allocated when the penalty gets smaller than {\tt\small reuse\_threshold} divided by two.
The rationale being that when the penalty term gets much smaller than the {\tt\small reuse\_threshold} index, keeping the {\tt\small damping\_info} structure with a small figure of merit is equivalent to de-allocating it (in the worst ---very unlikely --- case, it will only add the cost of re-allocating a new {\tt\small damping\_info} structure).

\section{Evaluation}

\subsection{Overview}

We used a topology of 27 routers in the NSL cluster to evaluate
our implementation.
This topology is composed of 10 Autonomous Systems :

\begin{center}
\includegraphics[scale=.3]{img/topology.png}
\end{center}

The experiment replays updates contained into an archive,
\textsl{updates.20100401.1729} (the archive comes from \cite{routeviews}).
This archive is composed of advertisements sent by 11 BGP routers and collected
over a period of time of 15 minutes.
All updates are sent to router 3 (\texttt{\small 10.0.0.3}), which then relays them
in the network.
We ran 3 simulations, with different settings :

\begin{enumerate}
\item The first simulation was run with the original BIRD code, without route damping.
\item The second one had route damping enabled and used the default parameters.
\item The third one used a more aggressive settings : \texttt{\small cut\_threshold} was lowered to 1000 (vs 1500 for the default setting).
\end{enumerate}

During the experiment, the number of updates and withdrawals were collected every 10 seconds (\textit{i.e.} we collected the total number of update/withdrawals received at every router).
The number of dampened routes was also collected, for the settings where route damping was enabled.
The number of updates/withdrawals cumulate over time, whereas the number of dampened routes is immediate.

\subsection{Evolution of dampened paths}

it represent time vs. the actual number of dampened routes in AS2
(actually, router 3)

also note that we aggregated results for each AS (for better readability)


\subsection{Number of route updates}

it's the difference between graph sim1 and graph sim3 -> i.e we have
less updates in SIM3 ! :-)

maybe we can also display one graph with the evolution -> show that
the number is quite huge !! and that's why we show the difference
rather than the two graph on top of each other !


\subsection{Number of withdrawals}

works for sim3, not for sim2 !


\section{Conclusion}

show importance of stability


\section{Future work}

possible extensions

real scale tests


\section{Acknowledgement}

\begin{thebibliography}{6}

\bibitem[1]{rfc2439}The RFC 2439, BGP Route Flap Damping, \href{http://www.ietf.org/rfc/rfc2439.txt}{http://www.ietf.org/rfc/rfc2439.txt}

\bibitem[2]{ripe recommendations} RIPE Recommendations On Route-flap
Damping, \href{http://www.ripe.net/ripe/docs/ripe-378}{http://www.ripe.net/ripe/docs/ripe-378}

\bibitem[3]{bird}Bird Routing Project, \href{http://bird.network.cz}{http://bird.network.cz}

\bibitem[4]{repository}Our publicly available repository, \href{https://github.com/alexchap/Albatros-Project}{https://github.com/alexchap/Albatros-Project}

\bibitem[5]{damping-pic}itcertnotes, \href{www.itcertnotes.com}{http://www.itcertnotes.com}

\bibitem[6]{routeviews}\href{http://routeviews.org}{http://routeviews.org} 

\end{thebibliography}

\end{document}
